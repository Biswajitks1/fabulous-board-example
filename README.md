# FABulous board example

## Summary

This repository documents the uploading of a bitstream to a
[caravel HAT](https://github.com/efabless/caravel_board/tree/main/hardware/nucleo/caravel_nucleo)
mounted onto a [Nucleo
board](https://www.st.com/en/evaluation-tools/nucleo-f746zg.html#overview) as
far as it is known. All files for doing so are taken from the [forked base
repository](https://github.com/gatecat/fabulous-mpw2-bringup). Currently there
exists only one combination of a preflashed board with an exension board on
which an FPGA created with
[FABulous](https://github.com/FPGA-Research-Manchester/FABulous) is mounted. In
the future it should therefore be checked if and how the nucleo board has to be
set up so it can forward the bitstream. There also might be other ways to to
upload the bitstream, but only this one is currently known. If you find other
(and simpler) ways, feel free to share them.

## Prerequisites

The upload process is based on a script calling micropython modules, so you
need to install [mpy-cross](https://pypi.org/project/mpy-cross/) and
[mpremote](https://pypi.org/project/mpremote). If you do not have a bitstream
yet, you first have to generate it using FABulous.

## Hardware

The board has to be connected over the ST-LINK USB Micro-B connector  ```CN1```
to the Nucleo board. If you want to check the GPIOs for timing failures, you
also have to follow [this guide](https://github.com/efabless/caravel_board/tree/main/firmware/mpw2-5/nucleo)

### PmodVGA wiring

In case the PmodVGA ever gets disconnected from the board, here is the wiring for
the demo:

- IO[15] => HS
- IO[16] => VS
- IO[17] => R3
- IO[18] => G3
- IO[19] => B3
- IO[22] => R2
- IO[23] => G2
- IO[24] => B2
- GND => GND

## Uploading a bitstream

Place the bitstream generated by fabulous into the ```sim/test_design```
directory. If you want to run the demo which displays the video of a street on a
VGA-monitor, use the file ```sim/test_design/vga_bram.v``` and
```sim/test_design/top_wrapper.v``` for the FABulous flow. For the script you
need to set the enironment variables ```FLASH``` and ```DEV```. ```FLASH``` has
to be an existing directory where a copy of the bitstream and the file created
by micropython will be stored. ```DEV``` is the port on which the board is
connected (probably ```/dev/ttyACM0```). If everything is set up, the scripts in
the ```caravel``` directory can be run to upload the bitstream. For the
VGA-demo, run ```run_vga_bram.sh``` to upload the bitstream. It might take a few
seconds before the demo is shown correctly, though this is not always the case.

## Resources

- [GPIO diagnostic](https://github.com/efabless/caravel_board/tree/main/firmware/mpw2-5/nucleo)
- [FABulous](https://github.com/FPGA-Research-Manchester/FABulous)
- [Caravel HAT](https://github.com/efabless/caravel_board/tree/main/hardware/nucleo/caravel_nucleo)
